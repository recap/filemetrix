flowchart TB

%% App & API
subgraph App["FastAPI Application"]
direction TB
Main["main.py
(app factory)"]
API["API Layer
(/api/v1/*)"]

    Main --> API

end

%% API Routes
subgraph Routes["API Endpoints"]
direction LR
RepoDiscovery["repo_discovery
(find/register repos)"]
PIDFetcherEP["pid_fetcher
(fetch PID metadata)"]
RepoWorkflow["repo_workflow_controller
(start harvests)"]
RepoMetrics["repo_metrics
(metrics queries)"]
end
API --> RepoDiscovery
API --> PIDFetcherEP
API --> RepoWorkflow
API --> RepoMetrics

%% External Sources
subgraph External["External Data Sources"]
direction TB
Re3data["re3data API
(repository registry)"]
OpenArchives["OAI-PMH Endpoints
(OpenArchives Data Providers)"]
PIDResolver["PID Metadata Providers
(e.g., Handle/DOI resolvers,
repository APIs)"]
OneData["OneData / OneProvider
(file-level metadata)"]
end

%% Services
subgraph Services["Service Clients / Integrations"]
direction TB
DiscoveryClient["Repository Discovery Logic
(checks re3data,
validates OAI endpoints)"]
OAIClient["OAI-PMH Harvester
(oai_harvester_client)"]
PIDClient["PID Fetcher
(dataset + file metadata)"]
OneDataClient["OneData Hugger
(file metadata expansion)"]
end

RepoDiscovery --> DiscoveryClient
DiscoveryClient --> Re3data
DiscoveryClient --> OpenArchives

RepoWorkflow --> OAIClient
OAIClient --> OpenArchives

PIDFetcherEP --> PIDClient
PIDClient --> PIDResolver

PIDClient --> OneDataClient
OneDataClient --> OneData

%% Persistence Layer
subgraph Persistence["Persistence & Processing"]
direction TB
Postgres["PostgreSQL
(SQLModel models)"]
Aggregator["Metrics Aggregator
(MIME types, sizes,
counts, time-series)"]
PIDClient --> Postgres
OAIClient --> Postgres
OneDataClient --> Postgres
Postgres --> Aggregator
Aggregator --> RepoMetrics
end
